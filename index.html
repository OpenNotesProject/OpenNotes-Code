<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Open Notes â€” Study Vault</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;800&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#F1F3E0;
  --panel:#FFFFFF;
  --panel-soft:#F7F9EB;
  --panel-alt:#D2DCB6;
  --accent:#A1BC98;
  --accent-dark:#778873;
  --muted:#6b6f60;
  --border:#d4ddc0;
  --radius:12px;
  --sans:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;
  --mono:'Source Code Pro',ui-monospace,Menlo,monospace;
  --transition: 220ms cubic-bezier(.2,.9,.2,1);
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--sans);
  background:var(--bg);
  color:#333;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* App layout */
.app{
  display:grid;
  grid-template-columns:300px 1fr;
  height:100vh;
  gap:1rem;
  padding:1rem;
}

/* Sidebar */
.sidebar{
  background:var(--panel-soft);
  border:1px solid var(--border);
  border-radius:12px;
  padding:1rem;
  display:flex;
  flex-direction:column;
  gap:1rem;
  overflow:auto;
  min-width:260px;
}
.sidebar-header{
  display:flex;
  gap:0.8rem;
  align-items:center;
}
.logo{
  width:44px;height:44px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent-dark),var(--accent));
  display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1rem;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}
.sidebar-title{font-weight:800;font-size:1.05rem}
.sidebar-sub{font-size:0.82rem;color:var(--muted)}

/* Search */
.search-bar{
  display:flex;align-items:center;gap:0.5rem;background:var(--panel);border-radius:10px;padding:0.45rem;border:1px solid var(--border);
}
.search-bar input{flex:1;border:0;outline:none;background:transparent;font-size:0.95rem;padding:0.25rem}
.kbd{font-family:var(--mono);font-size:0.75rem;padding:0.12rem 0.35rem;border-radius:6px;border:1px solid var(--border);background:#fff;color:var(--muted)}

/* Subjects dropdown / branches */
.subjects-dropdown{background:transparent;border-radius:8px;padding:0}
.subject-header{font-weight:700;color:var(--accent-dark);margin-bottom:0.4rem}
.branch{margin-bottom:0.6rem}
.branch-title{
  display:flex;align-items:center;gap:0.5rem;padding:0.35rem;border-radius:8px;cursor:pointer;font-weight:700;color:#2f4b3a;
  transition: background var(--transition), transform var(--transition);
}
.branch-title:hover{background:rgba(161,188,152,0.18); transform:translateY(-1px)}
.branch-children{
  margin-top:0.35rem;
  margin-left:0.4rem;
  border-left:2px solid rgba(0,0,0,0.04);
  padding-left:0.6rem;
  overflow:hidden;
  transition: max-height var(--transition), opacity var(--transition);
  max-height:0;
  opacity:0;
}
.branch-children.open{ max-height:2000px; opacity:1; }

/* note link */
.note-link{
  padding:0.28rem 0.4rem;border-radius:6px;cursor:pointer;font-size:0.95rem;color:#2f4b3a;
  transition: background var(--transition), transform var(--transition);
}
.note-link:hover{ background:rgba(161,188,152,0.18); transform:translateY(-2px) }

/* Main area */
.main{display:flex;flex-direction:column;gap:0.8rem}
.topbar{
  display:flex;align-items:center;justify-content:space-between;padding:0.8rem;border-radius:12px;background:var(--panel);border:1px solid var(--border);
}
.topbar-left{display:flex;align-items:center;gap:0.6rem}
.brush{display:inline-block;padding:0.08em 0.5em;border-radius:6px;color:#fff;font-weight:800;position:relative}
.brush::before{
  content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml;utf8,\
    <svg xmlns='http://www.w3.org/2000/svg' width='420' height='80' viewBox='0 0 420 80'>\
      <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%23A1BC98'/><stop offset='1' stop-color='%23778873'/></linearGradient></defs>\
      <g fill='url(%23g)'><path d='M0 40 C40 10, 120 10, 200 40 C280 70, 360 70, 420 40 L420 80 L0 80 Z'/></g></svg>");
  background-size:140% 140%; background-position:-10% 50%; z-index:-1;border-radius:6px;
}
.topbar-title{font-weight:700;color:#444}
.topbar-right{display:flex;align-items:center;gap:0.6rem;color:var(--muted)}
#shareBtn{background:var(--accent);border:none;padding:0.4rem 0.7rem;border-radius:8px;color:white;font-weight:700;cursor:pointer}

/* Note view */
.note-view-wrap{flex:1;overflow:auto;padding:0.6rem}
.note-card{
  background:var(--panel);border-radius:12px;padding:1.2rem;border:2px solid var(--accent);box-shadow:0 12px 30px rgba(0,0,0,0.06);position:relative;
}
.note-card::after{
  content:"";position:absolute;top:12px;left:12px;right:-12px;bottom:-12px;border-radius:12px;border:2px solid rgba(161,188,152,0.45);z-index:-1;transform:rotate(-0.6deg);
}
.note-meta{display:flex;gap:0.6rem;align-items:center;color:var(--muted);margin-bottom:0.6rem;flex-wrap:wrap}
.badge{background:var(--panel-soft);border:1px solid var(--accent-dark);padding:0.18rem 0.5rem;border-radius:999px;font-weight:700;color:var(--accent-dark)}
.note-title{margin:0 0 0.6rem;font-size:1.4rem;font-weight:800;color:#333}
.markdown{font-size:1rem;line-height:1.65;color:#444}
.markdown h1,h2,h3{margin-top:1rem;margin-bottom:0.4rem;color:#333}
.markdown code{font-family:var(--mono);background:var(--panel-soft);padding:0.12rem 0.28rem;border-radius:6px;border:1px solid var(--border)}
.markdown pre{background:var(--panel-soft);padding:0.7rem;border-radius:8px;border:1px solid var(--border);overflow:auto}

/* Breadcrumbs */
.breadcrumbs{display:flex;gap:0.4rem;align-items:center;font-size:0.9rem;color:var(--muted);margin-bottom:0.6rem}
.breadcrumbs a{color:var(--accent-dark);text-decoration:none;font-weight:700;cursor:pointer}
.breadcrumbs span.sep{color:var(--border)}

/* Recent notes (homepage) */
.recent-list{display:flex;flex-direction:column;gap:0.5rem;margin-top:0.6rem}
.recent-item{padding:0.5rem;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfff6);border:1px solid var(--border);cursor:pointer}
.recent-item:hover{background:rgba(161,188,152,0.12)}

/* Search results overlay */
.search-results{position:absolute;top:3.6rem;left:1rem;right:1rem;max-height:60vh;overflow:auto;background:white;border-radius:10px;border:1px solid var(--border);box-shadow:0 12px 30px rgba(0,0,0,0.12);z-index:40;display:none}
.search-result-item{padding:0.5rem 0.7rem;cursor:pointer}
.search-result-item:hover{background:rgba(161,188,152,0.18)}

/* Scrollbars */
.sidebar::-webkit-scrollbar,.note-view-wrap::-webkit-scrollbar,.search-results::-webkit-scrollbar{width:8px}
.sidebar::-webkit-scrollbar-thumb,.note-view-wrap::-webkit-scrollbar-thumb,.search-results::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.12);border-radius:999px}

/* Responsive */
@media (max-width:980px){
  .app{grid-template-columns:1fr}
  .sidebar{order:2;height:auto}
  .main{order:1}
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Open Notes vault">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Sidebar">
    <div class="sidebar-header">
      <div class="logo" aria-hidden="true">ON</div>
      <div>
        <div class="sidebar-title">Open Notes</div>
        <div class="sidebar-sub">Study Vault</div>
      </div>
    </div>

    <div class="search-bar" role="search" aria-label="Search notes">
      <input id="globalSearch" placeholder="Search notesâ€¦" aria-label="Search notes" />
      <span class="kbd"></span>
    </div>

    <div class="subjects-dropdown" id="subjectsDropdown" aria-label="Subjects">
      <div class="subject-header">Subjects</div>
      <!-- branches injected here -->
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="topbar" role="banner">
      <div class="topbar-left">
        <span class="brush" aria-hidden="true">Open Notes</span>
        <div class="topbar-title" id="currentPath">Loading vaultâ€¦</div>
      </div>
      <div class="topbar-right">
        <div id="status">Fetching from GitHubâ€¦</div>
        <button id="shareBtn" title="Copy link to this note">Share</button>
      </div>
    </header>

    <section class="note-view-wrap" id="noteViewWrap">
      <div class="note-card" id="noteCard">
        <nav class="breadcrumbs" id="breadcrumbs" aria-label="Breadcrumbs" style="display:none"></nav>

        <div class="note-meta">
          <span class="badge" id="noteTopic">Topic</span>
          <div id="noteInfo" style="color:var(--muted)">Select a note from the sidebar</div>
        </div>

        <h1 class="note-title" id="noteTitle">Welcome to OpenNotes!</h1>

        <div class="markdown" id="noteContent">
        
          <p>This vault reads <code>.md</code> files from a GitHub repo and renders them in a clean, Obsidian-style workspace.</p>
          <p>Structure your repo like:</p>
          <pre><code>science/
  biology/
    cells.md
    enzymes.md
  chemistry/
    bonding.md
maths/
  calculus.md
</code></pre>
          <p>If no note is selected, recent notes appear below for quick access.</p>

          <div id="recentSection" style="margin-top:1rem;">
            <h3 style="margin:0 0 0.6rem 0; color:var(--muted)">Recent notes</h3>
            <div class="recent-list" id="recentList"></div>
          </div>
        </div>
      </div>

      <div class="search-results" id="searchResults" role="listbox" aria-label="Search results"></div>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* -------------------------
   CONFIG: set your repo here
   ------------------------- */
const CONFIG = {
  owner: "OpenNotesProject",
  repo: "Notes",
  branch: "main",
  rootPath: "" // e.g. "notes"
};

/* -------------------------
   STATE & ELEMENTS
   ------------------------- */
const state = { tree: null, notesIndex: [], currentNote: null };
const subjectsDropdown = document.getElementById('subjectsDropdown');
const noteTitleEl = document.getElementById('noteTitle');
const noteContentEl = document.getElementById('noteContent');
const noteTopicEl = document.getElementById('noteTopic');
const noteInfoEl = document.getElementById('noteInfo');
const currentPathEl = document.getElementById('currentPath');
const statusEl = document.getElementById('status');
const searchInput = document.getElementById('globalSearch');
const searchResultsEl = document.getElementById('searchResults');
const shareBtn = document.getElementById('shareBtn');
const breadcrumbsEl = document.getElementById('breadcrumbs');
const recentListEl = document.getElementById('recentList');
const recentSection = document.getElementById('recentSection');

/* -------------------------
   URL helpers
   ------------------------- */
function setURL(path){
  const url = new URL(window.location);
  url.searchParams.set('note', path);
  window.history.replaceState({}, '', url);
}
function getURLNote(){
  const url = new URL(window.location);
  return url.searchParams.get('note');
}

/* -------------------------
   GitHub helpers
   ------------------------- */
function ghContentsUrl(path=''){
  const base = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents`;
  const full = CONFIG.rootPath ? `${CONFIG.rootPath}/${path}` : path;
  const encoded = full ? '/' + encodeURIComponent(full).replace(/%2F/g,'/') : '';
  return `${base}${encoded}?ref=${CONFIG.branch}`;
}
function ghRawUrl(path){
  const full = CONFIG.rootPath ? `${CONFIG.rootPath}/${path}` : path;
  return `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${full}`;
}

/* -------------------------
   Fetch tree recursively
   ------------------------- */
async function fetchTree(path=''){
  const res = await fetch(ghContentsUrl(path));
  if(!res.ok) throw new Error('GitHub fetch failed: ' + res.status);
  const items = await res.json();
  const folders = {};
  const files = [];
  for(const item of items){
    if(item.type === 'dir'){
      folders[item.name] = await fetchTree(path ? `${path}/${item.name}` : item.name);
    } else if(item.type === 'file' && item.name.toLowerCase().endsWith('.md')){
      files.push({ name: item.name, path: path ? `${path}/${item.name}` : item.name });
    }
  }
  return { folders, files };
}

/* -------------------------
   Render branch (recursive)
   supports unlimited depth, smooth expand/collapse
   ------------------------- */
function renderBranch(node, container, depth = 0, basePath = ''){
  // folders first
  const folderNames = Object.keys(node.folders).sort();
  folderNames.forEach(folder => {
    const folderWrap = document.createElement('div');
    folderWrap.className = 'branch';
    folderWrap.dataset.path = basePath ? `${basePath}/${folder}` : folder;

    const title = document.createElement('div');
    title.className = 'branch-title';
    title.style.paddingLeft = `${depth * 6}px`;
    title.innerHTML = `ðŸ“ ${folder}`;
    folderWrap.appendChild(title);

    const children = document.createElement('div');
    children.className = 'branch-children';
    folderWrap.appendChild(children);

    title.addEventListener('click', () => {
      const open = children.classList.toggle('open');
      // collapse others at same level for tidy view
      collapseSiblings(children, folderWrap.parentElement);
      // smooth: if opening, ensure max-height large enough (CSS handles)
    });

    container.appendChild(folderWrap);
    renderBranch(node.folders[folder], children, depth + 1, folderWrap.dataset.path);
  });

  // then files
  node.files.sort((a,b)=>a.name.localeCompare(b.name)).forEach(file => {
    const fileEl = document.createElement('div');
    fileEl.className = 'note-link';
    fileEl.style.paddingLeft = `${depth * 6}px`;
    fileEl.textContent = file.name.replace(/\.md$/,'');
    fileEl.dataset.path = file.path;
    fileEl.addEventListener('click', () => loadNote(file.path));
    container.appendChild(fileEl);
  });
}

/* collapse siblings helper */
function collapseSiblings(currentChildren, parent){
  if(!parent) return;
  parent.querySelectorAll('.branch-children').forEach(ch => {
    if(ch !== currentChildren) ch.classList.remove('open');
  });
}

/* -------------------------
   Render subjects (top-level)
   ------------------------- */
function renderSubjects(tree){
  subjectsDropdown.innerHTML = `<div class="subject-header">Subjects</div>`;
  const topFolders = Object.keys(tree.folders).sort();
  topFolders.forEach((subject, idx) => {
    const branch = document.createElement('div');
    branch.className = 'branch';
    const title = document.createElement('div');
    title.className = 'branch-title';
    title.innerHTML = `ðŸ“ ${subject}`;
    branch.appendChild(title);

    const children = document.createElement('div');
    children.className = 'branch-children';
    branch.appendChild(children);

    title.addEventListener('click', () => {
      const open = children.classList.toggle('open');
      collapseSiblings(children, subjectsDropdown);
    });

    subjectsDropdown.appendChild(branch);
    renderBranch(state.tree.folders[subject], children, 0, subject);

    // open first subject by default
    if(idx === 0) children.classList.add('open');
  });
}

/* -------------------------
   Load note, update UI, breadcrumbs, recent
   ------------------------- */
async function loadNote(path){
  try{
    statusEl.textContent = 'Loadingâ€¦';
    const res = await fetch(ghRawUrl(path));
    if(!res.ok) throw new Error('Failed to load note');
    const text = await res.text();

    const title = path.split('/').pop().replace(/\.md$/,'');
    const topic = path.split('/')[0] || 'Notes';

    noteTitleEl.textContent = title;
    noteTopicEl.textContent = topic;
    noteInfoEl.textContent = path;
    currentPathEl.textContent = path;
    noteContentEl.innerHTML = marked.parse(text);

    state.currentNote = { path, title, content: text };

    setURL(path);
    updateBreadcrumbs(path);
    addRecent(path);

    statusEl.textContent = 'Loaded';
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Error loading note';
  }
}

/* -------------------------
   Breadcrumbs
   clickable segments expand sidebar and optionally load note
   ------------------------- */
function updateBreadcrumbs(path){
  if(!path){
    breadcrumbsEl.style.display = 'none';
    return;
  }
  breadcrumbsEl.style.display = 'flex';
  breadcrumbsEl.innerHTML = '';
  const parts = path.split('/');
  let accum = [];
  parts.forEach((p, i) => {
    accum.push(p);
    const seg = accum.join('/');
    const isFile = p.toLowerCase().endsWith('.md') || i === parts.length - 1 && p.includes('.');
    const label = p.replace(/\.md$/,'');
    const a = document.createElement('a');
    a.textContent = label;
    a.href = 'javascript:void(0)';
    a.addEventListener('click', () => {
      // if clicking a folder segment, expand that path in sidebar
      expandPath(seg);
      // if last segment is a file, load it
      if(seg.toLowerCase().endsWith('.md')) loadNote(seg);
    });
    breadcrumbsEl.appendChild(a);
    if(i < parts.length - 1){
      const sep = document.createElement('span');
      sep.className = 'sep';
      sep.textContent = 'â€º';
      breadcrumbsEl.appendChild(sep);
    }
  });
}

/* Expand sidebar nodes matching a path (open branches along path) */
function expandPath(path){
  // path like "science/biology" or "science/biology/cells.md"
  const segments = path.split('/');
  let current = '';
  segments.forEach((seg, idx) => {
    current = current ? `${current}/${seg}` : seg;
    // find branch element with data-path === current
    const branch = document.querySelector(`.branch[data-path="${current}"]`);
    if(branch){
      const children = branch.querySelector('.branch-children');
      if(children) children.classList.add('open');
    }
  });
  // collapse other top-level branches for tidy view
  document.querySelectorAll('.branch-children').forEach(ch => {
    // keep those that are ancestors of path open
    const parentBranch = ch.parentElement;
    if(parentBranch && parentBranch.dataset.path){
      const p = parentBranch.dataset.path;
      if(!path.startsWith(p)) ch.classList.remove('open');
    }
  });
}

/* -------------------------
   Recent notes (localStorage)
   ------------------------- */
const RECENT_KEY = 'opennotes_recent';
function getRecent(){
  try{
    const raw = localStorage.getItem(RECENT_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch{ return []; }
}
function saveRecent(list){
  try{ localStorage.setItem(RECENT_KEY, JSON.stringify(list)); }catch{}
}
function addRecent(path){
  if(!path) return;
  const list = getRecent().filter(p => p !== path);
  list.unshift(path);
  if(list.length > 12) list.length = 12;
  saveRecent(list);
  renderRecent();
}
function renderRecent(){
  const list = getRecent();
  recentListEl.innerHTML = '';
  if(!list.length){
    recentListEl.innerHTML = '<div style="color:var(--muted)">No recent notes yet â€” open a note to add it here.</div>';
    return;
  }
  list.forEach(p => {
    const el = document.createElement('div');
    el.className = 'recent-item';
    el.textContent = p;
    el.addEventListener('click', () => loadNote(p));
    recentListEl.appendChild(el);
  });
}

/* -------------------------
   Build search index (loads all notes once)
   ------------------------- */
async function buildIndex(node){
  for(const file of node.files){
    try{
      const res = await fetch(ghRawUrl(file.path));
      if(!res.ok) continue;
      const text = await res.text();
      state.notesIndex.push({ path: file.path, title: file.name.replace(/\.md$/,''), content: text.toLowerCase() });
    }catch(e){
      console.warn('Index fetch failed for', file.path);
    }
  }
  for(const folder in node.folders){
    await buildIndex(node.folders[folder]);
  }
}

/* -------------------------
   Search UI
   ------------------------- */
function runSearch(q){
  q = q.toLowerCase().trim();
  if(!q){ searchResultsEl.style.display = 'none'; searchResultsEl.innerHTML = ''; return; }
  const results = state.notesIndex.filter(n => n.title.toLowerCase().includes(q) || n.content.includes(q)).slice(0,50);
  searchResultsEl.innerHTML = '';
  if(!results.length){
    const none = document.createElement('div'); none.className = 'search-result-item'; none.textContent = `No results for "${q}"`; searchResultsEl.appendChild(none);
    searchResultsEl.style.display = 'block'; return;
  }
  results.forEach(r => {
    const item = document.createElement('div');
    item.className = 'search-result-item';
    item.textContent = r.path;
    item.addEventListener('click', () => { searchResultsEl.style.display = 'none'; loadNote(r.path); });
    searchResultsEl.appendChild(item);
  });
  searchResultsEl.style.display = 'block';
}

/* -------------------------
   Keyboard shortcuts & events
   ------------------------- */
document.addEventListener('keydown', e => {
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){ e.preventDefault(); searchInput.focus(); }
  if(e.key.toLowerCase() === 'n' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){ e.preventDefault(); createNotePlaceholder(); }
});
searchInput.addEventListener('input', e => runSearch(e.target.value));
searchInput.addEventListener('blur', () => setTimeout(()=>{ searchResultsEl.style.display='none'; }, 150));

/* -------------------------
   Share button
   ------------------------- */
shareBtn.addEventListener('click', () => {
  if(!state.currentNote) return;
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    const prev = statusEl.textContent;
    statusEl.textContent = 'Link copied!';
    setTimeout(()=> statusEl.textContent = prev, 1400);
  });
});

/* -------------------------
   Placeholder create note (hook)
   ------------------------- */
function createNotePlaceholder(){
  alert('Create note flow â€” integrate your editor here.');
}

/* -------------------------
   Init: fetch tree, render, index, load URL note or show recent
   ------------------------- */
(async function init(){
  try{
    statusEl.textContent = 'Fetching vaultâ€¦';
    const tree = await fetchTree('');
    state.tree = tree;
    renderSubjects(tree);

    statusEl.textContent = 'Indexing notesâ€¦';
    await buildIndex(tree);
    statusEl.textContent = `Ready Â· ${state.notesIndex.length} notes indexed`;

    // render recent
    renderRecent();

    // if URL has note param, load it; else show recent (already visible)
    const urlNote = getURLNote();
    if(urlNote){
      // expand sidebar to show path
      expandPath(urlNote);
      await loadNote(urlNote);
    } else {
      currentPathEl.textContent = 'Recent';
      // show recent section (already in DOM)
    }
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Error loading vault';
    noteContentEl.innerHTML = `<p style="color:var(--muted)">Could not load repository. Check CONFIG and that the repo is public.</p>`;
  }
})();
</script>
</body>
</html>
